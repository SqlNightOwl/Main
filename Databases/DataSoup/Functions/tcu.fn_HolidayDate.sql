create function tcu.fn_HolidayDate
(	@Year			smallint
,	@MonthOccurs	tinyint
,	@Frequency		tinyint
,	@DayOccurs		tinyint
,	@IsFloating		bit		)
returns datetime
as
/*
????????????????????????????????????????????????????????????????????????????????
			c 2000-08 ? Texans Credit Union ? All rights reserved.
????????????????????????????????????????????????????????????????????????????????
Developer:	Paul Hunter
Created  :	10/16/2006
Purpose  :	Caclulates the desired holiday date based upon the parameters 
			provided.
History  :
  Date		Developer		Description
??????????	??????????????	????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????
*/
begin

	declare	@return	datetime

	--	return null if not valid years
	if @Year < 1900 or @Year > 3000
		return null

	--	return null if not valid months
	if @MonthOccurs < 1 or @MonthOccurs	> 12
		return null

	if @Frequency = 0
	begin
		--	return null if not valid day
		if @DayOccurs < 1 or @DayOccurs > 31
			return null
		if @MonthOccurs in (4, 6, 9, 11) and @DayOccurs > 30
			return null
		if @MonthOccurs = 2 and @DayOccurs > 29
			return null

		--	create the date string
		set	@return = cast(cast(@MonthOccurs as varchar) + '/' + cast(@DayOccurs as varchar)  + '/' + cast(@Year as varchar) as datetime)

		--	move it up a day if it's a floating holiday and it's on a Sunday
		if @IsFloating = 1 and datepart(weekday, @return) = 1	--	Sunday
			set	@return = dateadd(day, 1, @return)

	end
	else
	begin
		--	return null if not valid day
		if @DayOccurs < 1 or @DayOccurs > 7
			return null
		if @Frequency < 1 or @Frequency > 5
			return null

		--	weeks 1 thru 4
		if @Frequency < 5
		begin
			--	move to the first day of the month and move forward until you hit the desired day of the week
			set	@return = cast(cast(@MonthOccurs as varchar) + '/01/' + cast(@Year as varchar) as datetime)
			while datepart(weekday, @return) != @DayOccurs
			begin
				set	@return = dateadd(day, 1, @return)
			end
			--	move forward the desired number of weeks
			set	@return = dateadd(day, (7 * (@Frequency - 1)), @return)
		end
		else
		begin
			--	for the last week of the month, get the last day and backup
			set	@return = cast(cast(@MonthOccurs as varchar) + '/01/' + cast(@Year as varchar) as datetime)
			set	@return = dateadd(day, -1, dateadd(month, 1, @return))
			--	backup until you hit the desired day of the week
			while datepart(weekday, @return) != @DayOccurs
			begin
				set	@return = dateadd(day, -1, @return)
			end
		end
	end
	return @return
end
GO
