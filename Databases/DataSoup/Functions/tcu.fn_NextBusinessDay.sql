create function tcu.fn_NextBusinessDay
(	@startOn	datetime
,	@days	int	)
returns datetime
as
/*
????????????????????????????????????????????????????????????????????????????????
			c 2000-10 ? Texans Credit Union ? All rights reserved.
????????????????????????????????????????????????????????????????????????????????
Developer:	Paul Hunter
Created  :	07/02/2008
Purpose  :	Add the indicated number of business days to the start date.
History	 :
   Date		Developer		Description
??????????	??????????????	????????????????????????????????????????????????????
01/07/2010	Paul Hunter		Changed to use the tcu.Calendar table.
????????????????????????????????????????????????????????????????????????????????
*/
begin
	declare
		@loop		int
	,	@nextDay	datetime

	set @loop		= 0;
	set @nextDay	= @startOn;

	while @loop < @days
	begin
		set @nextDay = dateadd(day, 1, @nextDay);
		if 6 = ((@@datefirst + datepart(weekday, @nextDay) - 2) % 7) + 1  
			set @nextDay = @nextDay + 2;

		--	make a recursive function call to find the next business day
		select @nextDay = tcu.fn_NextBusinessDay(@nextDay, 1) 
		where exists (select holidayOn from tcu.Calendar where holidayOn = @nextDay);

		set @loop = @loop + 1;
	end;
	return @nextDay;
end;
GO
